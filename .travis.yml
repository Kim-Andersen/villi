dist: focal
language: node_js

node_js:
  - 14

addons:
  postgresql: '12'
  apt:
    packages:
      - postgresql-12-postgis-2.5
      - postgresql-client-12
      - postgresql-server-dev-12

services:
  - postgresql

env:
  global:
    - PGVER=12
    - PGPORT=5433
    - PGUSER=travis

cache:
  directories:
    - node_modules

before_script:
  - psql -U postgres -c "CREATE EXTENSION postgis"
  - psql -c 'CREATE DATABASE travis_ci_test;' -U postgres
  - npm install -g nodechef-cli
  - npm run setup
  - npm run build
  - npm run prepare-server-deploy

after_script:
  - nodechef deploy -i villi -auth ${NC_DEPLOY_TOKEN} -l server/deploy --rebuild
